name: Lint-check + Style-normalize Python files

on:
  pull_request:
    paths:
      - '.github/workflows/lint.yml'
      - '**.py'


jobs:
  build:
    name:  lint-check and style-normalize Python files
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.ref }}
    - name: Install uv
      uses: astral-sh/setup-uv@v6
      with:
        # Note: Caching (of the packages that `uv` builds while resolving dependencies) is "enabled by default on GitHub-hosted runners."
        #       Reference: https://github.com/astral-sh/setup-uv/blob/main/README.md#enable-caching
        #       Here, we make it so the cache gets invalidated whenever the `uv.lock` file changes.
        #       Reference: https://github.com/astral-sh/setup-uv/blob/main/README.md#cache-dependency-glob
        cache-dependency-glob: "uv.lock"
    - name: Set up Python virtual environment
      run: uv sync
    - name: Lint with flake8 and Reformat with black
      run: |
        make lint
        make black
    - name: commit and push if reformatted
      run: |
        git config user.name github-actions
        git config user.email github-actions@github.com
        if git status --short | grep -q '\.py$'; then git add '*.py' && git commit -m "style: reformat" && git push; fi

